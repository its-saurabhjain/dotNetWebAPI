<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>External Authentication Client</title>
</head>
<body>
    <h3>Authentication Response</h3>
    <form id="login">
        <input type="email" name="Email" placeholder="Email" value="itsaurabh@gmail.com" />
        <input type="password" name="Password" placeholder="Password" value="sj@11061974" />
    </form>
    <button type="submit" id="externalLoginList" value="GoogleLogin">External Logins</button>
    <button type="submit" id="googleAuth" value="GoogleAuth">Google Auth</button>
    <button type="submit" id="getUserInfo" value="GetUserInfo">Get UserInfo</button>
    <button type="submit" id="registerExtUser" value="RegisterUser">Register User</button>
    <pre id="output"></pre>
    <script src="Scripts/jquery-1.10.2.js"></script>
    <script>
        var googleUrl = "";
        var local_access_token = '';
        $(document).ready(function () {

            var accessor = { consumerSecret: '4WwMm5PmGUvsQMqVOhu4gYSr' };
            var parameter = {
                oauth_consumer_key: '384570901380-qo9736vnefaj1s0oai3daf82h348c2fg.apps.googleusercontent.com',
                oauth_callback: 'http://localhost:59670/'
            };
            //1. get the google url
            var loginListFunc = function () {
                var externalloginUrl = "/api/Account/ExternalLogins?returnUrl=%2F&generateState=false";
                $.get(externalloginUrl)
                    .success(saveUrl)
                    .always(showResponseFunc);
                return false;
            };
            var showResponseFunc = function (object) {
                $("#output").text(JSON.stringify(object, null, 4));
            };
            //this will also have the redirect url once authenticated
            var saveUrl = function (data) {
                var localgoogleUrl = data[0].Url
                var parameters = localgoogleUrl.split('&');
                //http://localhost:59670/default.html
                //changing the url redirection to default page, also Providers-->ApplicationOAuthProvider.cs needs to be changed
                var redirection = "redirect_uri=http%3A%2F%2Flocalhost%3A59670%2Fdefault.html";
                googleUrl = parameters[0] + '&' + parameters[1] + '&' + parameters[2] + '&' + redirection  + '&' + parameters[4];
            };

            var googleAuthFunc = function () {
                window.location.href = googleUrl;
            };
            var getAccessTokenFunc = function () {
                if (location.hash)
                {
                    if (location.hash.split("access_token=")) {
                        local_access_token = location.hash.split("access_token=")[1].split('&')[0];
                    }
                }
                return false;
            };
            var getUserInfoFunc= function(accesstoken){
                $.ajax('/api/account/userinfo', {
                    type: "GET",
                    headers: getHeaders()
                }).always(showResponseFunc);
                return false;
            };
            var getHeaders = function () {
                getAccessTokenFunc();
                if (local_access_token) {
                    
                    return { "Authorization": "Bearer " + local_access_token};
                }
            };
            var registerExternalUserFunc = function () {
                var regUrl = "api/account/RegisterExternal";
                var data = $("#login").serialize();
                //showResponseFunc(data);
                //$.post(regUrl, data).always(showResponseFunc);

                $.ajax('api/account/RegisterExternal', {
                    type: "POST",
                    headers: getHeaders(),
                    data: data
                }).always(showResponseFunc);
                return false;
            };

            $("#externalLoginList").click(loginListFunc);
            $("#googleAuth").click(googleAuthFunc);
            $("#getUserInfo").click(getUserInfoFunc);
            $("#registerExtUser").click(registerExternalUserFunc);

        });
      
    </script>
</body>
</html>